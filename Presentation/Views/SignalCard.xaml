<UserControl x:Class="CSharp_WPF_Websockets.Presentation.Views.SignalCard"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" 
             xmlns:converters="clr-namespace:CSharp_WPF_Websockets.Presentation.Converters"
             xmlns:lvc="clr-namespace:LiveChartsCore.SkiaSharpView.WPF;assembly=LiveChartsCore.SkiaSharpView.WPF">

    <UserControl.Resources>
        <converters:TypeToIconConverter x:Key="TypeToIconConverter"/>
        <converters:TypeToProgressVisibilityConverter x:Key="TypeToProgressVisibilityConverter"/>
        <converters:ValueDisplayConverter x:Key="ValueDisplayConverter"/>
        <converters:StatusConverter x:Key="StatusConverter"/>
        <converters:BoolToColorConverter x:Key="BoolToColorConverter"/>

        <!-- NUEVOS CONVERTIDORES -->
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>

        <SolidColorBrush x:Key="CardBackground" Color="#FF2A2A2A"/>
        <SolidColorBrush x:Key="CardBorder" Color="#FF404040"/>
        <SolidColorBrush x:Key="TextPrimary" Color="#FFE1E1E1"/>
        <SolidColorBrush x:Key="TextSecondary" Color="#FF9A9A9A"/>
        <SolidColorBrush x:Key="ChartBackground" Color="#FF2D2D2D"/>
        <SolidColorBrush x:Key="AccentColor" Color="#FF00A2E8"/>
        <SolidColorBrush x:Key="ControlBackground" Color="#FF1E1E1E"/>

        <Storyboard x:Key="ValueUpdateAnimation">
            <DoubleAnimation Storyboard.TargetName="ValueText"
                           Storyboard.TargetProperty="Opacity"
                           From="0.7" To="1.0" Duration="0:0:0.4"/>
        </Storyboard>

        <!-- ===== ESTILOS PARA CONTROLES ===== -->
        <Style x:Key="MinimalRefreshButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="{StaticResource CardBorder}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Foreground" Value="{StaticResource TextSecondary}"/>
            <Setter Property="FontSize" Value="10"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="FontWeight" Value="Light"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="3">
                            <ContentPresenter HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            Margin="{TemplateBinding Padding}"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#FF404040"/>
                                <Setter Property="Foreground" Value="{StaticResource TextPrimary}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter Property="Background" Value="{StaticResource AccentColor}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="CompactButton" TargetType="Button" BasedOn="{StaticResource MinimalRefreshButton}">
            <Setter Property="Padding" Value="6,3"/>
            <Setter Property="FontSize" Value="9"/>
            <Setter Property="MinWidth" Value="20"/>
        </Style>

        <Style x:Key="ToggleButtonStyle" TargetType="ToggleButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="{StaticResource CardBorder}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Foreground" Value="{StaticResource TextSecondary}"/>
            <Setter Property="FontSize" Value="10"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="3">
                            <ContentPresenter HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            Margin="{TemplateBinding Padding}"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter Property="Background" Value="{StaticResource AccentColor}"/>
                                <Setter Property="Foreground" Value="White"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#FF404040"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="CompactTextBox" TargetType="TextBox">
            <Setter Property="Background" Value="{StaticResource ControlBackground}"/>
            <Setter Property="BorderBrush" Value="{StaticResource CardBorder}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Foreground" Value="{StaticResource TextPrimary}"/>
            <Setter Property="FontSize" Value="9"/>
            <Setter Property="Padding" Value="4,2"/>
            <Setter Property="MinWidth" Value="40"/>
            <Setter Property="Height" Value="22"/>
        </Style>

        <Style x:Key="CompactLabel" TargetType="TextBlock">
            <Setter Property="Foreground" Value="{StaticResource TextSecondary}"/>
            <Setter Property="FontSize" Value="8"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
    </UserControl.Resources>

    <Border Background="{StaticResource CardBackground}"
            BorderBrush="{StaticResource CardBorder}"
            BorderThickness="1"
            CornerRadius="8"
            Padding="20"
            MinHeight="200">

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <!-- Header -->
                <RowDefinition Height="Auto"/>
                <!-- Value -->
                <RowDefinition Height="Auto"/>
                <!-- Chart Controls -->
                <RowDefinition MinHeight="300"/>
                <!-- Chart -->
                <RowDefinition Height="Auto"/>
                <!-- Scale Controls -->
                <RowDefinition Height="Auto"/>
                <!-- Footer -->
            </Grid.RowDefinitions>

            <!-- ===== HEADER ===== -->
            <Grid Grid.Row="0" Margin="0,0,0,12">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <Ellipse Grid.Column="0" Width="6" Height="6" 
                        Fill="{Binding StatusColor}" 
                        Margin="0,0,12,0"
                        VerticalAlignment="Center"/>

                <TextBlock Grid.Column="1" Text="{Binding Name}" 
                          FontWeight="Light" 
                          Foreground="{StaticResource TextPrimary}" 
                          FontSize="14"
                          VerticalAlignment="Center"/>

                <TextBlock Grid.Column="2" 
                          Text="{Binding Type}" 
                          FontSize="10"
                          Foreground="{StaticResource TextSecondary}"
                          VerticalAlignment="Center"/>
            </Grid>

            <!-- ===== VALUE DISPLAY ===== -->
            <Grid Grid.Row="1" Margin="0,0,0,16">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0" x:Name="ValueText" 
                          Text="{Binding DisplayValue}"
                          FontSize="24" 
                          FontWeight="Light"
                          Foreground="{Binding Color}"
                          VerticalAlignment="Center"/>

                <TextBlock Grid.Column="1" 
                          Text="{Binding Timestamp, StringFormat='{}{0:HH:mm:ss}'}"
                          FontSize="10" 
                          Foreground="{StaticResource TextSecondary}"
                          VerticalAlignment="Bottom"/>
            </Grid>

            <!-- ===== CHART TOOLBAR ===== -->
            <Border Grid.Row="2" Margin="0,0,0,8"
                    Background="Transparent"
                    BorderBrush="{StaticResource CardBorder}"
                    BorderThickness="0,0,0,1"
                    Padding="0,0,0,8">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Info del auto-scale -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock Text="Auto:" Style="{StaticResource CompactLabel}" Margin="0,0,4,0"/>
                        <TextBlock Text="{Binding YMin, StringFormat='Y: {0:F1}'}" 
                                  Style="{StaticResource CompactLabel}" Margin="0,0,4,0"/>
                        <TextBlock Text="{Binding YMax, StringFormat='-{0:F1}'}" 
                                  Style="{StaticResource CompactLabel}" Margin="0,0,8,0"/>
                        <TextBlock Text="{Binding TimeWindowMinutes, StringFormat='T: {0:F1}m'}" 
                                  Style="{StaticResource CompactLabel}"/>
                    </StackPanel>

                    <!-- Controles rápidos -->
                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                        <ToggleButton Content="AUTO" 
                                     IsChecked="{Binding IsAutoScale}"
                                     Command="{Binding ToggleAutoScaleCommand}"
                                     Style="{StaticResource ToggleButtonStyle}"
                                     ToolTip="Toggle Auto Scale"
                                     Margin="0,0,4,0"/>

                        <Button Content="+" 
                               Command="{Binding ZoomInCommand}"
                               Style="{StaticResource CompactButton}"
                               ToolTip="Zoom In"
                               Margin="0,0,2,0"/>

                        <Button Content="-" 
                               Command="{Binding ZoomOutCommand}"
                               Style="{StaticResource CompactButton}"
                               ToolTip="Zoom Out"
                               Margin="0,0,4,0"/>

                        <Button Content="⚙" 
                               Command="{Binding ToggleScaleControlsCommand}"
                               Style="{StaticResource CompactButton}"
                               ToolTip="Scale Controls"/>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- ===== CHART ===== -->
            <Border Grid.Row="3" 
                    Background="Transparent"
                    CornerRadius="4"
                    BorderBrush="{StaticResource CardBorder}"
                    BorderThickness="1"
                    Margin="0,0,0,0">
                <lvc:CartesianChart x:Name="SignalChart"
                    Series="{Binding ChartSeries, UpdateSourceTrigger=PropertyChanged}"
                    XAxes="{Binding XAxes, UpdateSourceTrigger=PropertyChanged}"
                    YAxes="{Binding YAxes, UpdateSourceTrigger=PropertyChanged}"
                    AnimationsSpeed="00:00:00"
                    EasingFunction="{x:Null}"/>
            </Border>

            <!-- ===== SCALE CONTROLS (COLLAPSIBLE) ===== -->
            <Border Grid.Row="4" 
                    Background="{StaticResource ControlBackground}"
                    BorderBrush="{StaticResource CardBorder}"
                    BorderThickness="0,1,0,0"
                    Padding="12,8"
                    Margin="0,8,0,0"
                    Visibility="Visible">

                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="8"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Manual Scale Controls -->
                    <Grid Grid.Row="0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Column="0" Text="Y Min:" Style="{StaticResource CompactLabel}" Margin="0,0,4,0"/>
                        <TextBox Grid.Column="1" 
                                Text="{Binding ManualYMin, StringFormat=F2}" 
                                Style="{StaticResource CompactTextBox}"
                                Margin="0,0,12,0"/>

                        <TextBlock Grid.Column="2" Text="Y Max:" Style="{StaticResource CompactLabel}" Margin="0,0,4,0"/>
                        <TextBox Grid.Column="3" 
                                Text="{Binding ManualYMax, StringFormat=F2}" 
                                Style="{StaticResource CompactTextBox}"
                                Margin="0,0,12,0"/>

                        <TextBlock Grid.Column="4" Text="Time (min):" Style="{StaticResource CompactLabel}" Margin="0,0,4,0"/>
                        <TextBox Grid.Column="5" 
                                Text="{Binding ManualTimeWindow, StringFormat=F4}" 
                                Style="{StaticResource CompactTextBox}"
                                Margin="0,0,8,0"/>

                        <Button Grid.Column="6" 
                               Content="Apply"
                               Command="{Binding ApplyManualScaleCommand}"
                               Style="{StaticResource MinimalRefreshButton}"/>
                    </Grid>

                    <!-- Action Buttons -->
                    <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center">
                        <Button Content="Reset Scale" 
                               Command="{Binding ResetScaleCommand}"
                               Style="{StaticResource MinimalRefreshButton}"
                               Margin="0,0,8,0"/>

                        <Button Content="Refresh Chart" 
                               Command="{Binding ManualRefreshChartCommand}"
                               Style="{StaticResource MinimalRefreshButton}"/>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- ===== FOOTER ===== -->
            <Border Grid.Row="5" 
                    Background="Transparent"
                    BorderBrush="{StaticResource CardBorder}"
                    BorderThickness="0,1,0,0"
                    Padding="0,8,0,0">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0" 
                              Text="{Binding StatusText}" 
                              FontSize="10" 
                              Foreground="{Binding StatusColor}"
                              VerticalAlignment="Center"/>

                    <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                        <Ellipse Width="3" Height="3" 
                                Fill="{Binding Color}" 
                                Margin="0,0,6,0"/>
                        <TextBlock Text="Live" 
                                  FontSize="9" 
                                  Foreground="{StaticResource TextSecondary}"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>
    </Border>
</UserControl>